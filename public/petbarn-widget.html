<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Petbarn Shop</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #e63946 0%, #d62839 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: 700;
    }

    .logo-icon {
      font-size: 32px;
    }

    .cart-btn {
      position: relative;
      background: white;
      color: #e63946;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .cart-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .cart-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #1d3557;
      color: white;
      font-size: 12px;
      font-weight: 700;
      min-width: 22px;
      height: 22px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }

    .cart-badge.empty {
      display: none;
    }

    /* Category Tabs */
    .categories {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .category-btn {
      padding: 10px 20px;
      border: 2px solid #e63946;
      background: white;
      color: #e63946;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .category-btn:hover {
      background: #fff5f5;
    }

    .category-btn.active {
      background: #e63946;
      color: white;
    }

    /* Product Grid */
    .products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .product-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #f0f0f0;
    }

    .product-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .product-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .product-price {
      font-size: 18px;
      font-weight: 700;
      color: #e63946;
      margin-bottom: 12px;
    }

    /* Quantity Controls */
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qty-btn {
      width: 32px;
      height: 32px;
      border: 2px solid #e63946;
      background: white;
      color: #e63946;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .qty-btn:hover {
      background: #e63946;
      color: white;
    }

    .qty-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .qty-display {
      min-width: 32px;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
    }

    .add-btn {
      flex: 1;
      padding: 10px 16px;
      background: #e63946;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .add-btn:hover {
      background: #d62839;
    }

    .add-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Cart Drawer */
    .cart-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 100;
    }

    .cart-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .cart-drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 380px;
      max-width: 100%;
      height: 100%;
      background: white;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 101;
      display: flex;
      flex-direction: column;
    }

    .cart-overlay.open .cart-drawer {
      transform: translateX(0);
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
      background: #f9f9f9;
    }

    .cart-header h2 {
      font-size: 20px;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      padding: 4px;
      line-height: 1;
    }

    .close-btn:hover {
      color: #333;
    }

    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .cart-empty {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .cart-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .cart-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .cart-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      background: #f0f0f0;
    }

    .cart-item-details {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .cart-item-price {
      font-size: 14px;
      color: #e63946;
      font-weight: 600;
    }

    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .cart-item-qty .qty-btn {
      width: 28px;
      height: 28px;
      font-size: 16px;
    }

    .remove-btn {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
    }

    .remove-btn:hover {
      color: #e63946;
    }

    .cart-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      background: #f9f9f9;
    }

    .cart-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 700;
    }

    .cart-total-amount {
      color: #e63946;
      font-size: 24px;
    }

    .checkout-btn {
      width: 100%;
      padding: 16px;
      background: #1d3557;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .checkout-btn:hover {
      background: #152a45;
    }

    .checkout-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Order Confirmation */
    .order-confirmation {
      text-align: center;
      padding: 40px 20px;
    }

    .confirmation-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .confirmation-title {
      font-size: 24px;
      font-weight: 700;
      color: #2a9d8f;
      margin-bottom: 8px;
    }

    .confirmation-order-id {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
    }

    .confirmation-total {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 24px;
    }

    .continue-btn {
      padding: 14px 32px;
      background: #e63946;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
    }

    .continue-btn:hover {
      background: #d62839;
    }

    /* Loading state */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">üêæ</span>
        <span>Petbarn</span>
      </div>
      <button class="cart-btn" onclick="openCart()">
        üõí Cart
        <span class="cart-badge" id="cartBadge">0</span>
      </button>
    </header>

    <!-- Order Confirmation (hidden by default) -->
    <div id="orderConfirmation" style="display: none;">
      <div class="order-confirmation">
        <div class="confirmation-icon">üéâ</div>
        <div class="confirmation-title">Order Confirmed!</div>
        <div class="confirmation-order-id" id="confirmationOrderId"></div>
        <div class="confirmation-total" id="confirmationTotal"></div>
        <button class="continue-btn" onclick="continueShopping()">Continue Shopping</button>
      </div>
    </div>

    <!-- Main Shop Content -->
    <div id="shopContent">
      <!-- Category Tabs -->
      <div class="categories" id="categories">
        <button class="category-btn active" data-category="all" onclick="filterCategory('all')">üêæ All</button>
        <button class="category-btn" data-category="dog" onclick="filterCategory('dog')">üêï Dogs</button>
        <button class="category-btn" data-category="cat" onclick="filterCategory('cat')">üê± Cats</button>
      </div>

      <!-- Products Grid -->
      <div class="products" id="products"></div>
    </div>
  </div>

  <!-- Cart Overlay -->
  <div class="cart-overlay" id="cartOverlay" onclick="closeCart()">
    <div class="cart-drawer" onclick="event.stopPropagation()">
      <div class="cart-header">
        <h2>üõí Your Cart</h2>
        <button class="close-btn" onclick="closeCart()">√ó</button>
      </div>
      <div class="cart-items" id="cartItems">
        <div class="cart-empty">
          <div class="cart-empty-icon">üõí</div>
          <p>Your cart is empty</p>
        </div>
      </div>
      <div class="cart-footer">
        <div class="cart-total">
          <span>Total</span>
          <span class="cart-total-amount" id="cartTotal">$0.00</span>
        </div>
        <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled>
          Proceed to Checkout
        </button>
      </div>
    </div>
  </div>

  <script>
    // Default product catalog (embedded for immediate rendering)
    const DEFAULT_PRODUCTS = [
      {
        id: "dog-1",
        name: "Royal Canin Adult Dog",
        price: 89.99,
        description: "Premium nutrition for adult dogs, supports healthy digestion",
        category: "dog",
        image: "https://placehold.co/200x200/e8d5b7/333?text=üêï+Royal+Canin",
      },
      {
        id: "dog-2",
        name: "Hill's Science Diet Puppy",
        price: 74.99,
        description: "Specially formulated for growing puppies with DHA",
        category: "dog",
        image: "https://placehold.co/200x200/e8d5b7/333?text=üê∂+Hills",
      },
      {
        id: "dog-3",
        name: "Blue Buffalo Wilderness",
        price: 64.99,
        description: "High-protein, grain-free recipe with real chicken",
        category: "dog",
        image: "https://placehold.co/200x200/e8d5b7/333?text=üêï+Blue+Buffalo",
      },
      {
        id: "dog-4",
        name: "Purina Pro Plan Sport",
        price: 59.99,
        description: "Advanced nutrition for active dogs, 30% protein",
        category: "dog",
        image: "https://placehold.co/200x200/e8d5b7/333?text=üêï+Purina",
      },
      {
        id: "cat-1",
        name: "Royal Canin Indoor Cat",
        price: 49.99,
        description: "Tailored nutrition for indoor cats, hairball control",
        category: "cat",
        image: "https://placehold.co/200x200/d5e8e8/333?text=üê±+Royal+Canin",
      },
      {
        id: "cat-2",
        name: "Hill's Science Diet Adult",
        price: 44.99,
        description: "Balanced nutrition for adult cats, easy digestion",
        category: "cat",
        image: "https://placehold.co/200x200/d5e8e8/333?text=üê±+Hills",
      },
      {
        id: "cat-3",
        name: "Blue Buffalo Tastefuls",
        price: 39.99,
        description: "Natural cat food with real salmon, no by-products",
        category: "cat",
        image: "https://placehold.co/200x200/d5e8e8/333?text=üê±+Blue+Buffalo",
      },
      {
        id: "cat-4",
        name: "Purina ONE Healthy Kitten",
        price: 34.99,
        description: "DHA for brain and vision development in kittens",
        category: "cat",
        image: "https://placehold.co/200x200/d5e8e8/333?text=üê±+Purina",
      },
    ];

    // State
    let state = {
      products: DEFAULT_PRODUCTS,
      cart: { items: [], total: 0, itemCount: 0 },
      categories: ["all", "dog", "cat"],
      currentCategory: "all",
      orderConfirmation: null,
      quantities: {}, // Track selected quantities per product
    };

    let isLoading = false;

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      // Try to get initial data from OpenAI context
      if (window.openai?.content?.structuredContent) {
        updateState(window.openai.content.structuredContent);
      }

      // Render immediately with default products
      render();

      // Listen for tool call results
      window.addEventListener("openai-after-tool-call", (event) => {
        const result = event.detail?.result?.structuredContent;
        if (result) {
          updateState(result);
        }
        isLoading = false;
        document.getElementById("app").classList.remove("loading");
      });
    });

    function updateState(data) {
      if (data.products) state.products = data.products;
      if (data.cart) state.cart = data.cart;
      if (data.categories) state.categories = data.categories;
      if (data.currentCategory) state.currentCategory = data.currentCategory;
      if (data.orderConfirmation) {
        state.orderConfirmation = data.orderConfirmation;
        showOrderConfirmation();
      } else {
        state.orderConfirmation = null;
        hideOrderConfirmation();
      }

      // Reset quantities for products not in cart
      state.quantities = {};
      state.cart.items.forEach(item => {
        state.quantities[item.productId] = item.quantity;
      });

      render();
    }

    function render() {
      renderProducts();
      renderCart();
      updateCartBadge();
      updateCategoryButtons();
    }

    function renderProducts() {
      const container = document.getElementById("products");
      const filtered = state.currentCategory === "all" 
        ? state.products 
        : state.products.filter(p => p.category === state.currentCategory);

      container.innerHTML = filtered.map(product => {
        const cartItem = state.cart.items.find(i => i.productId === product.id);
        const inCart = !!cartItem;
        const qty = state.quantities[product.id] || 1;

        return `
          <div class="product-card">
            <img class="product-image" src="${product.image}" alt="${product.name}" />
            <div class="product-name">${product.name}</div>
            <div class="product-description">${product.description}</div>
            <div class="product-price">$${product.price.toFixed(2)}</div>
            <div class="quantity-controls">
              <button class="qty-btn" onclick="changeQty('${product.id}', -1)" ${qty <= 1 ? 'disabled' : ''}>‚àí</button>
              <span class="qty-display">${qty}</span>
              <button class="qty-btn" onclick="changeQty('${product.id}', 1)">+</button>
              <button class="add-btn" onclick="addToCart('${product.id}')">
                ${inCart ? '‚úì Update Cart' : 'Add to Cart'}
              </button>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderCart() {
      const container = document.getElementById("cartItems");
      const checkoutBtn = document.getElementById("checkoutBtn");

      if (state.cart.items.length === 0) {
        container.innerHTML = `
          <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            <p>Your cart is empty</p>
          </div>
        `;
        checkoutBtn.disabled = true;
      } else {
        container.innerHTML = state.cart.items.map(item => `
          <div class="cart-item">
            <img class="cart-item-image" src="${item.image}" alt="${item.name}" />
            <div class="cart-item-details">
              <div class="cart-item-name">${item.name}</div>
              <div class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
              <div class="cart-item-qty">
                <button class="qty-btn" onclick="updateCartQty('${item.productId}', ${item.quantity - 1})">‚àí</button>
                <span class="qty-display">${item.quantity}</span>
                <button class="qty-btn" onclick="updateCartQty('${item.productId}', ${item.quantity + 1})">+</button>
              </div>
            </div>
            <button class="remove-btn" onclick="removeFromCart('${item.productId}')">üóëÔ∏è</button>
          </div>
        `).join("");
        checkoutBtn.disabled = false;
      }

      document.getElementById("cartTotal").textContent = `$${state.cart.total.toFixed(2)}`;
    }

    function updateCartBadge() {
      const badge = document.getElementById("cartBadge");
      badge.textContent = state.cart.itemCount;
      badge.classList.toggle("empty", state.cart.itemCount === 0);
    }

    function updateCategoryButtons() {
      document.querySelectorAll(".category-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.category === state.currentCategory);
      });
    }

    // UI Actions
    function changeQty(productId, delta) {
      const current = state.quantities[productId] || 1;
      const newQty = Math.max(1, current + delta);
      state.quantities[productId] = newQty;
      renderProducts();
    }

    function openCart() {
      document.getElementById("cartOverlay").classList.add("open");
    }

    function closeCart() {
      document.getElementById("cartOverlay").classList.remove("open");
    }

    function filterCategory(category) {
      state.currentCategory = category;
      render();
    }

    function showOrderConfirmation() {
      const conf = state.orderConfirmation;
      document.getElementById("shopContent").style.display = "none";
      document.getElementById("orderConfirmation").style.display = "block";
      document.getElementById("confirmationOrderId").textContent = `Order ID: ${conf.orderId}`;
      document.getElementById("confirmationTotal").textContent = `Total: $${conf.total.toFixed(2)} (${conf.itemCount} items)`;
      closeCart();

      // Notify ChatGPT about successful checkout
      if (window.openai?.completeChat) {
        window.openai.completeChat(`Order ${conf.orderId} placed successfully!`);
      }
    }

    function hideOrderConfirmation() {
      document.getElementById("shopContent").style.display = "block";
      document.getElementById("orderConfirmation").style.display = "none";
    }

    function continueShopping() {
      state.orderConfirmation = null;
      hideOrderConfirmation();
    }

    // MCP Tool Calls - use optimistic local updates for smooth UX
    async function callTool(name, args) {
      // Perform optimistic local update first
      if (name === "add_to_cart") {
        const product = state.products.find(p => p.id === args.productId);
        if (product) {
          const existingItem = state.cart.items.find(i => i.productId === args.productId);
          if (existingItem) {
            existingItem.quantity = args.quantity || existingItem.quantity + 1;
          } else {
            state.cart.items.push({
              productId: product.id,
              name: product.name,
              price: product.price,
              quantity: args.quantity || 1,
              image: product.image,
            });
          }
          recalculateCart();
          render();
        }
      } else if (name === "remove_from_cart") {
        state.cart.items = state.cart.items.filter(i => i.productId !== args.productId);
        recalculateCart();
        render();
      } else if (name === "update_quantity") {
        const item = state.cart.items.find(i => i.productId === args.productId);
        if (item) {
          if (args.quantity <= 0) {
            state.cart.items = state.cart.items.filter(i => i.productId !== args.productId);
          } else {
            item.quantity = args.quantity;
          }
          recalculateCart();
          render();
        }
      } else if (name === "checkout") {
        if (state.cart.items.length > 0) {
          const orderId = `PB-${Date.now().toString(36).toUpperCase()}`;
          state.orderConfirmation = {
            orderId,
            total: state.cart.total,
            itemCount: state.cart.itemCount,
            status: "confirmed",
          };
          state.cart = { items: [], total: 0, itemCount: 0 };
          showOrderConfirmation();
        }
      }

      // Also call the server (fire and forget for sync)
      if (window.openai?.callTool) {
        try {
          window.openai.callTool(name, args);
        } catch (err) {
          console.error("Tool call failed:", err);
        }
      }
    }

    function recalculateCart() {
      state.cart.total = state.cart.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
      state.cart.itemCount = state.cart.items.reduce((sum, item) => sum + item.quantity, 0);
    }

    function addToCart(productId) {
      const qty = state.quantities[productId] || 1;
      callTool("add_to_cart", { productId, quantity: qty });
    }

    function removeFromCart(productId) {
      callTool("remove_from_cart", { productId });
    }

    function updateCartQty(productId, quantity) {
      if (quantity <= 0) {
        callTool("remove_from_cart", { productId });
      } else {
        callTool("update_quantity", { productId, quantity });
      }
    }

    function checkout() {
      callTool("checkout", {});
    }
  </script>
</body>
</html>
